name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  Lint:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      # Run Ruff
      - name: Run Ruff
        run: |
          pip install uv
          uv pip install --system ruff
          ruff check
      # Run Codespell
      - name: Run Codespell
        run: |
          pip install codespell
          codespell codespell src/**/*.py

  DownloadAssets:
    name: Download Assets
    runs-on: ubuntu-latest
    steps:
      - name: Download Images & Matcaps
        shell: bash
        run: |
          mkdir -p examples/images
          mkdir -p examples/matcaps
          
          git clone --depth 1 --filter=blob:none --sparse https://github.com/niivue/niivue.git temp_nv_assets
          cd temp_nv_assets
          
          git sparse-checkout set packages/niivue/demos/images packages/niivue/demos/matcaps
          
          mv packages/niivue/demos/images/* ../examples/images/
          mv packages/niivue/demos/matcaps/* ../examples/matcaps/
          
          cd ..
          rm -rf temp_nv_assets
      - uses: actions/upload-artifact@v6
        with:
          name: niivue-assets
          path: examples/
          retention-days: 1

  Test:
    needs: DownloadAssets
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        os:
          - ubuntu-latest
          - macos-latest # arm64 (Apple Silicon)
          - macos-13 # latest Intel release
          - windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download Images & Matcaps
        uses: actions/download-artifact@v7
        with:
          name: niivue-assets
          path: .

      # requires npm because JS needs to be built
      - uses: actions/setup-node@v6
        with:
          node-version: "18.x"
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - run: |
          pip install pytest-notebook
          pip install pre-commit
          pre-commit run --all
          pre-commit install
      # pipx install hatch
      # hatch run test --cover --nb-test-files
      - name: Install IPyNiiVue & Deps
        run: pip install -e .
      - name: Test import
        run: |
          python -c "import ipyniivue"
      - name: Test IPyNiiVue
        run: |
          pip install pytest-cov
          pip install --upgrade pip ipython ipykernel
          ipython kernel install --name "python3" --user
          mkdir -p ./reports
          pytest --cov --cov-report=json:./reports/coverage.json --cov-report=xml:./reports/coverage.xml
      - name: Upload ipyniivue test coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage_ipyniivue-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ./reports/coverage.json
      - name: Generate Markdown summary of code coverage
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: ./reports/coverage.xml
          format: markdown
          output: both
          thresholds: "10 10"
      - name: Add test results to job summary
        run: |
          cat ./code-coverage-results.md >> $GITHUB_STEP_SUMMARY
      - name: Test example notebooks
        run: |
          pip install nbmake
          rm -rf ./reports
          mkdir -p ./reports
          pytest --nbmake examples/*ipynb --cov=src --cov-report=json:./reports/coverage.json --cov-report=xml:./reports/coverage.xml
      - name: Upload ipyniivue example notebooks coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage_ipyniivue_notebooks-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ./reports/coverage.json
      - name: Generate Markdown summary of code coverage
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: ./reports/coverage.xml
          format: markdown
          output: both
          thresholds: "10 10"
      - name: Add test results to job summary
        run: |
          cat ./code-coverage-results.md >> $GITHUB_STEP_SUMMARY
  E2E:
    name: E2E
    needs: DownloadAssets
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Check out repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Hatch
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade hatch

      - name: Install system deps (Playwright)
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk1.0-0 libatk-bridge2.0-0 libgtk-3-0 libx11-xcb1 libxcomposite1 libasound2 || true

      - name: Install npm deps
        working-directory: packages/ipyniivue
        run: npm ci || npm install --no-audit --no-fund
        
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: (Optional) create hatch env
        run: |
          hatch env create || true

      - name: Run e2e (npm script)
        env:
          CI: true
        run: npm run test:e2e
        # If your package.json with scripts is in a subfolder, add:
        # working-directory: packages/ipyniivue

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report-${{ matrix.os || 'linux' }}-${{ github.run_id }}
          path: |
            playwright-report
            test-results
            reports
            .playwright
            # adjust paths to your artifact locations

      - name: Cleanup generated html (optional)
        if: always()
        run: |
          npm run test:e2e:clean || true
  LintJavaScript:
    name: JavaScript / Lint
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v6
      - uses: biomejs/setup-biome@v2
        with:
          version: 1.9.4
      - run: biome ci .

  TypecheckJavaScript:
    name: JavaScript / Typecheck
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "22.x"
      - run: |
          npm install
          npm run typecheck